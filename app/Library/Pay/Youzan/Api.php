<?php
namespace App\Library\Pay\Youzan; use App\Library\Pay\ApiInterface; class Api implements ApiInterface { private $url_notify = ''; private $url_return = ''; public function __construct($spae6a5b) { $this->url_notify = SYS_URL_API . '/pay/notify/' . $spae6a5b; $this->url_return = SYS_URL . '/pay/return/' . $spae6a5b; } private function getAccessToken($sp42f333) { $sp9b471a = $sp42f333['client_id']; $sp0c1c74 = $sp42f333['client_secret']; $sp3bed73 = array('kdt_id' => $sp42f333['kdt_id']); $sp594fbb = (new Open\Token($sp9b471a, $sp0c1c74))->getToken('self', $sp3bed73); if (!isset($sp594fbb['access_token'])) { \Log::error('Pay.Youzan.goPay.getToken Error: ' . json_encode($sp594fbb)); throw new \Exception('平台支付Token获取失败'); } return $sp594fbb['access_token']; } function goPay($sp42f333, $sp79d97c, $spf49dcd, $spa1a573, $sp39c1e2) { $sp5daeb8 = strtolower($sp42f333['payway']); try { $sp286111 = $this->getAccessToken($sp42f333); $sp2fe5ce = new Open\Client($sp286111); } catch (\Exception $spa9e936) { \Log::error('Pay.Youzan.goPay getAccessToken error', array('exception' => $spa9e936)); throw new \Exception('支付渠道响应超时，请刷新重试'); } $sp5e6808 = array('qr_type' => 'QR_TYPE_DYNAMIC', 'qr_price' => $sp39c1e2, 'qr_name' => $spf49dcd, 'qr_source' => $sp79d97c); $sp594fbb = $sp2fe5ce->get('youzan.pay.qrcode.create', '3.0.0', $sp5e6808); $sp594fbb = isset($sp594fbb['response']) ? $sp594fbb['response'] : $sp594fbb; if (!isset($sp594fbb['qr_url'])) { \Log::error('Pay.Youzan.goPay.getQrcode Error: ' . json_encode($sp594fbb)); throw new \Exception('平台支付二维码获取失败'); } \App\Order::whereOrderNo($sp79d97c)->update(array('pay_trade_no' => $sp594fbb['qr_id'])); header('location: /qrcode/pay/' . $sp79d97c . '/youzan_' . strtolower($sp5daeb8) . '?url=' . urlencode($sp594fbb['qr_url'])); die; } function verify($sp42f333, $sp7b72fc) { $spf1c6fe = isset($sp42f333['isNotify']) && $sp42f333['isNotify']; $sp9b471a = $sp42f333['client_id']; $sp0c1c74 = $sp42f333['client_secret']; if ($spf1c6fe) { $sp6aa447 = file_get_contents('php://input'); $sp631d11 = json_decode($sp6aa447, true); if (@$sp631d11['test']) { echo 'test success'; return false; } try { $sp32b59e = $sp631d11['msg']; } catch (\Exception $spa9e936) { \Log::error('Pay.Youzan.verify get input error#1', array('exception' => $spa9e936, 'post_raw' => $sp6aa447)); echo 'fatal error'; return false; } $sp18e6b5 = $sp9b471a . '' . $sp32b59e . '' . $sp0c1c74; $sp7b1c1e = md5($sp18e6b5); if ($sp7b1c1e != $sp631d11['sign']) { \Log::error('Pay.Youzan.verify, sign error $sign_string:' . $sp18e6b5 . ', $sign' . $sp7b1c1e); echo 'fatal error'; return false; } else { echo json_encode(array('code' => 0, 'msg' => 'success')); } $sp32b59e = json_decode(urldecode($sp32b59e), true); if ($sp631d11['type'] === 'TRADE_ORDER_STATE' && $sp32b59e['status'] === 'TRADE_SUCCESS') { try { $sp286111 = $this->getAccessToken($sp42f333); $sp2fe5ce = new Open\Client($sp286111); } catch (\Exception $spa9e936) { \Log::error('Pay.Youzan.verify getAccessToken error#1', array('exception' => $spa9e936)); echo 'fatal error'; return false; } $sp5e6808 = array('tid' => $sp32b59e['tid']); $sp594fbb = $sp2fe5ce->get('youzan.trade.get', '3.0.0', $sp5e6808); if (isset($sp594fbb['error_response'])) { \Log::error('Pay.Youzan.verify with error：' . $sp594fbb['error_response']['msg']); echo 'fatal error'; return false; } $sp7f8d87 = $sp594fbb['response']['trade']; $sp871a53 = \App\Order::where('pay_trade_no', $sp7f8d87['qr_id'])->first(); if ($sp871a53) { $sp6f5c44 = $sp32b59e['tid']; $sp7b72fc($sp871a53->order_no, intval($sp7f8d87['payment'] * 100), $sp6f5c44); } } return true; } else { $sp79d97c = @$sp42f333['out_trade_no']; if (strlen($sp79d97c) < 5) { throw new \Exception('交易单号未传入'); } $sp871a53 = \App\Order::whereOrderNo($sp79d97c)->firstOrFail(); if (!$sp871a53->pay_trade_no || !strlen($sp871a53->pay_trade_no)) { return false; } try { $sp286111 = $this->getAccessToken($sp42f333); $sp2fe5ce = new Open\Client($sp286111); } catch (\Exception $spa9e936) { \Log::error('Pay.Youzan.verify getAccessToken error#2', array('exception' => $spa9e936)); throw new \Exception('支付渠道响应超时，请刷新重试'); } $sp5e6808 = array('qr_id' => $sp871a53->pay_trade_no, 'status' => 'TRADE_RECEIVED'); $sp594fbb = $sp2fe5ce->get('youzan.trades.qr.get', '3.0.0', $sp5e6808); $sp6982d7 = isset($sp594fbb['response']) ? $sp594fbb['response'] : $sp594fbb; if (!isset($sp6982d7['total_results'])) { \Log::error('Pay.Youzan.verify with error：The result of [youzan.trades.qr.get] has no key named [total_results]', array('result' => $sp594fbb)); return false; } if ($sp6982d7['total_results'] > 0 && count($sp6982d7['qr_trades']) > 0 && isset($sp6982d7['qr_trades'][0]['qr_id']) && $sp6982d7['qr_trades'][0]['qr_id'] === $sp871a53->pay_trade_no) { $spd9e6a1 = $sp6982d7['qr_trades'][0]; $sp6f5c44 = $spd9e6a1['tid']; $sp7b72fc($sp79d97c, intval($spd9e6a1['real_price'] * 100), $sp6f5c44); return true; } else { return false; } } } }