<?php
require_once '../lib/WxPay.Api.php'; class MicroPay { public function pay($spfde146) { $sp594fbb = WxPayApi::micropay($spfde146, 5); if (!array_key_exists('return_code', $sp594fbb) || !array_key_exists('out_trade_no', $sp594fbb) || !array_key_exists('result_code', $sp594fbb)) { echo '接口调用失败,请确认是否输入是否有误！'; throw new WxPayException('接口调用失败！'); } $sp79d97c = $spfde146->GetOut_trade_no(); if ($sp594fbb['return_code'] == 'SUCCESS' && $sp594fbb['result_code'] == 'FAIL' && $sp594fbb['err_code'] != 'USERPAYING' && $sp594fbb['err_code'] != 'SYSTEMERROR') { return false; } $sp164216 = 10; while ($sp164216 > 0) { $sp01c7ff = 0; $sp31d422 = $this->query($sp79d97c, $sp01c7ff); if ($sp01c7ff == 2) { sleep(2); continue; } else { if ($sp01c7ff == 1) { return $sp31d422; } else { return false; } } } if (!$this->cancel($sp79d97c)) { throw new WxpayException('撤销单失败！'); } return false; } public function query($sp79d97c, &$sp2cfc96) { $sp763cf8 = new WxPayOrderQuery(); $sp763cf8->SetOut_trade_no($sp79d97c); $sp594fbb = WxPayApi::orderQuery($sp763cf8); if ($sp594fbb['return_code'] == 'SUCCESS' && $sp594fbb['result_code'] == 'SUCCESS') { if ($sp594fbb['trade_state'] == 'SUCCESS') { $sp2cfc96 = 1; return $sp594fbb; } else { if ($sp594fbb['trade_state'] == 'USERPAYING') { $sp2cfc96 = 2; return false; } } } if ($sp594fbb['err_code'] == 'ORDERNOTEXIST') { $sp2cfc96 = 0; } else { $sp2cfc96 = 2; } return false; } public function cancel($sp79d97c, $sp6f109a = 0) { if ($sp6f109a > 10) { return false; } $sp67e41b = new WxPayReverse(); $sp67e41b->SetOut_trade_no($sp79d97c); $sp594fbb = WxPayApi::reverse($sp67e41b); if ($sp594fbb['return_code'] != 'SUCCESS') { return false; } if ($sp594fbb['result_code'] != 'SUCCESS' && $sp594fbb['recall'] == 'N') { return true; } else { if ($sp594fbb['recall'] == 'Y') { return $this->cancel($sp79d97c, ++$sp6f109a); } } return false; } }