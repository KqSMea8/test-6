<?php
namespace App\Library\Pay\WeChat; use App\Library\CurlRequest; use App\Library\Helper; use App\Library\Pay\ApiInterface; use Illuminate\Support\Facades\Log; class Api implements ApiInterface { private $url_notify = ''; private $url_return = ''; public function __construct($spae6a5b) { $this->url_notify = SYS_URL_API . '/pay/notify/' . $spae6a5b; $this->url_return = SYS_URL . '/pay/return/' . $spae6a5b; } function goPay($sp42f333, $sp79d97c, $spf49dcd, $spa1a573, $sp39c1e2) { $spda7912 = $sp39c1e2; $spc21a73 = strtoupper($sp42f333['payway']); if (strpos(@$_SERVER['HTTP_USER_AGENT'], 'MicroMessenger') !== false) { $spc21a73 = 'JSAPI'; $sp08c579 = (isset($_SERVER['HTTPS']) && $_SERVER['HTTPS'] === 'on' ? 'https' : 'http') . "://{$_SERVER['HTTP_HOST']}" . '/pay/' . $sp79d97c; $sp431c0a = 'https://open.weixin.qq.com/connect/oauth2/authorize?appid=' . $sp42f333['APPID'] . '&redirect_uri=' . urlencode($sp08c579) . '&response_type=code&scope=snsapi_base#wechat_redirect'; if (!isset($_GET['code'])) { header('Location: ' . $sp431c0a); die; } $sp49f68e = 'https://api.weixin.qq.com/sns/oauth2/access_token?appid=' . $sp42f333['APPID'] . '&secret=' . $sp42f333['APPSECRET'] . '&code=' . $_GET['code'] . '&grant_type=authorization_code'; $sp7210a9 = @json_decode(CurlRequest::get($sp49f68e), true); if (!$sp7210a9 || !isset($sp7210a9['openid'])) { if (isset($sp7210a9['errcode']) && $sp7210a9['errcode'] === 40163) { header('Location: ' . $sp431c0a); die; } die('<h1>获取微信OPENID<br>错误信息: ' . (isset($sp7210a9['errcode']) ? $sp7210a9['errcode'] : $sp7210a9) . '<br>' . (isset($sp7210a9['errmsg']) ? $sp7210a9['errmsg'] : $sp7210a9) . '<br>请返回重试</h1>'); } $sp7a1bcc = $sp7210a9['openid']; } $this->defineWxConfig($sp42f333); require_once __DIR__ . '/lib/WxPay.Api.php'; require_once 'WxPay.NativePay.php'; require_once 'wxLog.php'; $spb965e6 = new \NativePay(); $spf7fa80 = new \WxPayUnifiedOrder(); $spf7fa80->SetBody($spf49dcd); $spf7fa80->SetAttach($sp79d97c); $spf7fa80->SetOut_trade_no($sp79d97c); $spf7fa80->SetTotal_fee($spda7912); $spf7fa80->SetTime_start(date('YmdHis')); $spf7fa80->SetTime_expire(date('YmdHis', time() + 600)); $spf7fa80->SetGoods_tag('pay'); $spf7fa80->SetNotify_url($this->url_notify); $spf7fa80->SetTrade_type($spc21a73); if ($spc21a73 === 'MWEB') { $spf7fa80->SetScene_info('{"h5_info": {"type":"Wap","wap_url": "' . SYS_URL . '","wap_name": "发卡平台"}}'); } if ($spc21a73 === 'JSAPI') { $spf7fa80->SetOpenid($sp7a1bcc); } $spf7fa80->SetProduct_id($sp79d97c); $spf7fa80->SetSpbill_create_ip(Helper::getIP()); $sp594fbb = $spb965e6->unifiedOrder($spf7fa80); function getValue($sp79d97c, $sp594fbb, $spb5c5a0) { if (!isset($sp594fbb[$spb5c5a0])) { Log::error('Pay.WeChat.goPay, order_no:' . $sp79d97c . ', error:' . json_encode($sp594fbb)); if (isset($sp594fbb['err_code_des'])) { throw new \Exception($sp594fbb['err_code_des']); } if (isset($sp594fbb['return_msg'])) { throw new \Exception($sp594fbb['return_msg']); } throw new \Exception('获取支付数据失败'); } return $sp594fbb[$spb5c5a0]; } if ($spc21a73 === 'NATIVE') { $spaf19c1 = getValue($sp79d97c, $sp594fbb, 'code_url'); header('Location: /qrcode/pay/' . $sp79d97c . '/wechat?url=' . urlencode($spaf19c1)); } elseif ($spc21a73 === 'JSAPI') { $sp5e6808 = array('appId' => $sp42f333['APPID'], 'timeStamp' => time(), 'nonceStr' => md5(time() . 'nonceStr'), 'package' => 'prepay_id=' . getValue($sp79d97c, $sp594fbb, 'prepay_id'), 'signType' => 'MD5'); $sp631d11 = new \WxPayJsApiPay(); $sp631d11->FromArray($sp5e6808); $sp5e6808['paySign'] = $sp631d11->MakeSign(); header('Location: /qrcode/pay/' . $sp79d97c . '/wechat?url=' . urlencode(json_encode($sp5e6808))); } elseif ($spc21a73 === 'MWEB') { $spaf19c1 = getValue($sp79d97c, $sp594fbb, 'mweb_url'); $spe1ac0d = (isset($_SERVER['HTTPS']) && $_SERVER['HTTPS'] === 'on' ? 'https' : 'http') . "://{$_SERVER['HTTP_HOST']}" . '/qrcode/pay/' . $sp79d97c . '/wechat?url=h5'; echo view('utils.redirect', array('url' => $spaf19c1 . '&redirect_url=' . urlencode($spe1ac0d))); } die; } private function defineWxConfig($sp42f333) { if (!defined('wx_APPID')) { define('wx_APPID', $sp42f333['APPID']); } if (!defined('wx_MCHID')) { define('wx_MCHID', $sp42f333['MCHID']); } if (!defined('wx_KEY')) { define('wx_KEY', $sp42f333['KEY']); } if (!defined('wx_APPSECRET')) { define('wx_APPSECRET', $sp42f333['APPSECRET']); } } function verify($sp42f333, $sp7b72fc) { $spf1c6fe = isset($sp42f333['isNotify']) && $sp42f333['isNotify']; $this->defineWxConfig($sp42f333); require_once __DIR__ . '/lib/WxPay.Api.php'; require_once 'wxLog.php'; if ($spf1c6fe) { return (new PayNotifyCallBack($sp7b72fc))->Handle(false); } else { $sp79d97c = @$sp42f333['out_trade_no']; $spf7fa80 = new \WxPayOrderQuery(); $spf7fa80->SetOut_trade_no($sp79d97c); $sp594fbb = \WxPayApi::orderQuery($spf7fa80); if (array_key_exists('trade_state', $sp594fbb) && $sp594fbb['trade_state'] == 'SUCCESS') { call_user_func_array($sp7b72fc, array($sp594fbb['out_trade_no'], $sp594fbb['total_fee'], $sp594fbb['transaction_id'])); return true; } else { return false; } } } }