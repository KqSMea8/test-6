<?php
namespace App\Library\Pay\Codepay; use App\Library\Pay\ApiInterface; use Illuminate\Support\Facades\Log; class Api implements ApiInterface { private $url_notify = ''; private $url_return = ''; public function __construct($spae6a5b) { $this->url_notify = SYS_URL_API . '/pay/notify/' . $spae6a5b; $this->url_return = SYS_URL . '/pay/return/' . $spae6a5b; } function goPay($sp42f333, $sp79d97c, $spf49dcd, $spa1a573, $sp39c1e2) { $spda7912 = sprintf('%.2f', $sp39c1e2 / 100); $sp53b407 = $sp42f333['id']; $spca5df5 = $sp42f333['key']; switch ($sp42f333['payway']) { case 'alipay': $sp9265a0 = 1; break; case 'qq': $sp9265a0 = 2; break; case 'weixin': $sp9265a0 = 3; break; default: throw new \Exception('支付方式填写错误, alipay/qq/weixin'); } $sp631d11 = array('id' => $sp53b407, 'pay_id' => $sp79d97c, 'type' => $sp9265a0, 'price' => $spda7912, 'param' => '', 'notify_url' => $this->url_notify, 'return_url' => $this->url_return); ksort($sp631d11); $sp7b1c1e = ''; $sp1887c2 = ''; foreach ($sp631d11 as $spb5c5a0 => $spe3999d) { if ($spe3999d == '' || $spb5c5a0 == 'sign') { continue; } if ($sp7b1c1e != '') { $sp7b1c1e .= '&'; $sp1887c2 .= '&'; } $sp7b1c1e .= "{$spb5c5a0}={$spe3999d}"; $sp1887c2 .= "{$spb5c5a0}=" . urlencode($spe3999d); } $spd92986 = $sp1887c2 . '&sign=' . md5($sp7b1c1e . $spca5df5); var_dump('加载中'); header('Location: http://api2.fateqq.com:52888/creat_order/?' . $spd92986); die; } function verify($sp42f333, $sp7b72fc) { $spf1c6fe = isset($sp42f333['isNotify']) && $sp42f333['isNotify']; $sp53b407 = $sp42f333['id']; $spca5df5 = $sp42f333['key']; if (empty($_POST)) { $_POST = $_GET; } ksort($_POST); reset($_POST); $sp7b1c1e = ''; foreach ($_POST as $spb5c5a0 => $spe3999d) { if ($spe3999d == '' || $spb5c5a0 == 'sign') { continue; } if ($sp7b1c1e) { $sp7b1c1e .= '&'; } $sp7b1c1e .= "{$spb5c5a0}={$spe3999d}"; } if (!isset($_POST['pay_no']) || md5($sp7b1c1e . $spca5df5) != $_POST['sign']) { if ($spf1c6fe) { echo 'fail'; } return false; } else { if (!isset($_POST['pay_id'])) { Log::error('CodePay.verify ERROR: there is no pay_id in $_POST', array('$_POST' => json_encode($_POST))); if ($spf1c6fe) { echo 'fail'; } return false; } $sp79d97c = $_POST['pay_id']; $sp1ae8d8 = intval((double) $_POST['price'] * 100); $sp649e9d = $_POST['pay_no']; $sp7b72fc($sp79d97c, $sp1ae8d8, $sp649e9d); if ($spf1c6fe) { echo 'success'; } return true; } } }