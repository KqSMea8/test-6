<?php
namespace App\Http\Controllers\Merchant; use App\Library\Response; use Carbon\Carbon; use Illuminate\Http\Request; use App\Http\Controllers\Controller; class Coupon extends Controller { function get(Request $sp2f63b0) { $spd92986 = $this->authQuery($sp2f63b0, \App\Coupon::class)->with(array('category' => function ($spd92986) { $spd92986->select(array('id', 'name')); }))->with(array('product' => function ($spd92986) { $spd92986->select(array('id', 'name')); })); $sp11a77c = $sp2f63b0->post('search', false); $sp971b24 = $sp2f63b0->post('val', false); if ($sp11a77c && $sp971b24) { if ($sp11a77c == 'id') { $spd92986->where('id', $sp971b24); } else { $spd92986->where($sp11a77c, 'like', '%' . $sp971b24 . '%'); } } $sp97f886 = (int) $sp2f63b0->post('category_id'); $sp18574f = $sp2f63b0->post('product_id', -1); if ($sp97f886 > 0) { if ($sp18574f > 0) { $spd92986->where('product_id', $sp18574f); } else { $spd92986->where('category_id', $sp97f886); } } $sp17830c = $sp2f63b0->post('status'); if (strlen($sp17830c)) { $spd92986->whereIn('status', explode(',', $sp17830c)); } $sp9265a0 = $sp2f63b0->post('type'); if (strlen($sp9265a0)) { $spd92986->whereIn('type', explode(',', $sp9265a0)); } $spd92986->orderByRaw('expire_at DESC,category_id,product_id,type,status'); $sp5ea5e7 = $sp2f63b0->post('current_page', 1); $sp67decc = $sp2f63b0->post('per_page', 20); $sp176180 = $spd92986->paginate($sp67decc, array('*'), 'page', $sp5ea5e7); return Response::success($sp176180); } function create(Request $sp2f63b0) { $sp761f2d = $sp2f63b0->post('count', 0); $sp9265a0 = (int) $sp2f63b0->post('type', \App\Coupon::TYPE_ONETIME); $sp49901c = $sp2f63b0->post('expire_at'); $spfe4030 = (int) $sp2f63b0->post('discount_val'); $sp183fd6 = (int) $sp2f63b0->post('discount_type', \App\Coupon::DISCOUNT_TYPE_AMOUNT); $spef4726 = $sp2f63b0->post('remark'); if ($sp183fd6 === \App\Coupon::DISCOUNT_TYPE_AMOUNT) { if ($spfe4030 < 1 || $spfe4030 > 1000000000) { return Response::fail('优惠券面额需要在0.01-10000000之间'); } } if ($sp183fd6 === \App\Coupon::DISCOUNT_TYPE_PERCENT) { if ($spfe4030 < 1 || $spfe4030 > 100) { return Response::fail('优惠券面额需要在1-100之间'); } } $sp97f886 = (int) $sp2f63b0->post('category_id', -1); $sp18574f = (int) $sp2f63b0->post('product_id', -1); if ($sp9265a0 === \App\Coupon::TYPE_REPEAT) { $sp09ef00 = $sp2f63b0->post('coupon'); if (!$sp09ef00) { $sp09ef00 = strtoupper(str_random()); } $sp1d157c = new \App\Coupon(); $sp1d157c->user_id = $this->getUserIdOrFail($sp2f63b0); $sp1d157c->category_id = $sp97f886; $sp1d157c->product_id = $sp18574f; $sp1d157c->coupon = $sp09ef00; $sp1d157c->type = $sp9265a0; $sp1d157c->discount_val = $spfe4030; $sp1d157c->discount_type = $sp183fd6; $sp1d157c->count_all = (int) $sp2f63b0->post('count_all', 1); if ($sp1d157c->count_all < 1 || $sp1d157c->count_all > 10000000) { return Response::fail('可用次数不能超过10000000'); } $sp1d157c->expire_at = $sp49901c; $sp1d157c->saveOrFail(); return Response::success(array($sp1d157c->coupon)); } elseif ($sp9265a0 === \App\Coupon::TYPE_ONETIME) { if (!$sp761f2d) { return Response::forbidden('请输入生成数量'); } if ($sp761f2d > 100) { return Response::forbidden('每次生成不能大于100张'); } $sp0e8248 = array(); $spde34cd = array(); $sp203bcb = $this->getUserIdOrFail($sp2f63b0); $sp5f1c2b = Carbon::now(); for ($sp3deb2c = 0; $sp3deb2c < $sp761f2d; $sp3deb2c++) { $sp1d157c = strtoupper(str_random()); $spde34cd[] = $sp1d157c; $sp0e8248[] = array('user_id' => $sp203bcb, 'coupon' => $sp1d157c, 'category_id' => $sp97f886, 'product_id' => $sp18574f, 'type' => $sp9265a0, 'discount_val' => $spfe4030, 'discount_type' => $sp183fd6, 'status' => \App\Coupon::STATUS_NORMAL, 'remark' => $spef4726, 'created_at' => $sp5f1c2b, 'expire_at' => $sp49901c); } \App\Coupon::insert($sp0e8248); return Response::success($spde34cd); } else { return Response::forbidden('unknown type: ' . $sp9265a0); } } function edit(Request $sp2f63b0) { $spae6a5b = (int) $sp2f63b0->post('id'); $sp09ef00 = $sp2f63b0->post('coupon'); $sp97f886 = (int) $sp2f63b0->post('category_id', -1); $sp18574f = (int) $sp2f63b0->post('product_id', -1); $sp49901c = $sp2f63b0->post('expire_at', NULL); $sp17830c = (int) $sp2f63b0->post('status', \App\Coupon::STATUS_NORMAL); $sp9265a0 = (int) $sp2f63b0->post('type', \App\Coupon::TYPE_ONETIME); $spfe4030 = (int) $sp2f63b0->post('discount_val'); $sp183fd6 = (int) $sp2f63b0->post('discount_type', \App\Coupon::DISCOUNT_TYPE_AMOUNT); if ($sp183fd6 === \App\Coupon::DISCOUNT_TYPE_AMOUNT) { if ($spfe4030 < 1 || $spfe4030 > 1000000000) { return Response::fail('优惠券面额需要在0.01-10000000之间'); } } if ($sp183fd6 === \App\Coupon::DISCOUNT_TYPE_PERCENT) { if ($spfe4030 < 1 || $spfe4030 > 100) { return Response::fail('优惠券面额需要在1-100之间'); } } $sp1d157c = $this->authQuery($sp2f63b0, \App\Coupon::class)->find($spae6a5b); if ($sp1d157c) { $sp1d157c->coupon = $sp09ef00; $sp1d157c->category_id = $sp97f886; $sp1d157c->product_id = $sp18574f; $sp1d157c->status = $sp17830c; $sp1d157c->type = $sp9265a0; $sp1d157c->discount_val = $spfe4030; $sp1d157c->discount_type = $sp183fd6; if ($sp9265a0 === \App\Coupon::TYPE_REPEAT) { $sp1d157c->count_all = (int) $sp2f63b0->post('count_all', 1); if ($sp1d157c->count_all < 1 || $sp1d157c->count_all > 10000000) { return Response::fail('可用次数不能超过10000000'); } } if ($sp49901c) { $sp1d157c->expire_at = $sp49901c; } $sp1d157c->saveOrFail(); } else { $spd23533 = explode('
', $sp09ef00); for ($sp3deb2c = 0; $sp3deb2c < count($spd23533); $sp3deb2c++) { $sp08b87e = str_replace('', '', trim($spd23533[$sp3deb2c])); $sp1d157c = new \App\Coupon(); $sp1d157c->coupon = $sp08b87e; $sp1d157c->category_id = $sp97f886; $sp1d157c->product_id = $sp18574f; $sp1d157c->status = $sp17830c; $sp1d157c->type = $sp9265a0; $sp1d157c->discount_val = $spfe4030; $sp1d157c->discount_type = $sp183fd6; $spd23533[$sp3deb2c] = $sp1d157c; } \App\Product::find($sp18574f)->coupons()->saveMany($spd23533); } return Response::success(); } function enable(Request $sp2f63b0) { $sp125d2b = $sp2f63b0->post('ids', ''); if (strlen($sp125d2b) < 1) { return Response::forbidden(); } $sp68b3e7 = (int) $sp2f63b0->post('enabled'); $this->authQuery($sp2f63b0, \App\Coupon::class)->whereIn('id', explode(',', $sp125d2b))->update(array('enabled' => $sp68b3e7)); return Response::success(); } function delete(Request $sp2f63b0) { $sp125d2b = $sp2f63b0->post('ids', ''); if (strlen($sp125d2b) < 1) { return Response::forbidden(); } $this->authQuery($sp2f63b0, \App\Coupon::class)->whereIn('id', explode(',', $sp125d2b))->delete(); return Response::success(); } }